<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Products - GroceryShop</title>
{% load static %}
<script src="{% static 'js/dialog.js' %}"></script>
<style>
:root {
    --bg:#f3faf9; --text:#0b3f3a; --brand:#0f766e;
    --primary:#14b8a6; --primary-strong:#0ea5a3; --on-primary:#062a27;
    --field:#fff; --field-border:#c7e7e2; --success:#10b981;
    --error:#ef4444; --warning:#f59e0b;
}
body {margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);}
.container {max-width:1200px;margin:48px auto;padding:0 24px;}
.page-header{text-align:center;margin-bottom:40px;}
.page-header h1{font-size:36px;color:var(--brand);margin:0 0 8px 0;letter-spacing:0.2px;}
.page-header p{color:#6b7280;font-size:18px;margin:0;}
.filters{display:flex;justify-content:center;gap:16px;margin-bottom:32px;flex-wrap:wrap;}
.filter-btn{padding:8px 16px;border:2px solid var(--field-border);background:var(--field);color:var(--text);border-radius:8px;cursor:pointer;font-weight:500;transition:all 160ms ease;}
.filter-btn:hover,.filter-btn.active{border-color:var(--primary);background:var(--primary);color:var(--on-primary);}
.search-bar{display:flex;justify-content:center;margin-bottom:32px;}
.search-input{width:100%;max-width:400px;padding:12px 16px;border:2px solid var(--field-border);border-radius:8px;background:var(--field);color:var(--text);font-size:16px;outline:none;transition:border-color 160ms ease;}
.search-input:focus{border-color:var(--primary);}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:24px;margin-bottom:48px;}
.product-card{background:var(--field);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.05);overflow:hidden;transition:transform 160ms ease,box-shadow 160ms ease;position:relative;}
.product-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,0.15);}
.product-image{width:100%;height:200px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
.product-image img{width:100%;height:100%;object-fit:cover;}
.product-image .placeholder{color:#9ca3af;font-size:48px;}
.product-badge{position:absolute;top:12px;right:12px;background:var(--success);color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;}
.product-info{padding:20px;}
.product-category{color:var(--primary);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin:0 0 8px 0;}
.product-name{font-size:18px;font-weight:600;color:var(--text);margin:0 0 8px 0;line-height:1.3;}
.product-description{color:#6b7280;font-size:14px;line-height:1.4;margin:0 0 16px 0;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.product-price{font-size:20px;font-weight:700;color:var(--brand);margin:0 0 16px 0;}
.product-stock{font-size:12px;color:#6b7280;margin:0 0 16px 0;}
.product-actions{display:flex;gap:8px;}
.btn-add-cart{flex:1;padding:10px 16px;border:none;border-radius:8px;background:var(--primary);color:var(--on-primary);font-weight:600;cursor:pointer;transition:background-color 160ms ease,transform 80ms ease;}
.btn-add-cart:hover{background:var(--primary-strong);}
.btn-add-cart:active{transform:translateY(1px);}
.btn-add-cart:disabled{background:#e5e7eb;color:#9ca3af;cursor:not-allowed;}
@media (max-width:768px){.container{margin:24px auto;padding:0 16px;}.products-grid{grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;}.filters{flex-direction:column;align-items:center;}.filter-btn{width:200px;text-align:center;}}
.messages{margin-bottom:24px;}
.messages .success{padding:12px 16px;border-radius:8px;background:#d1fae5;color:#065f46;border:1px solid #a7f3d0;}
.messages .error{padding:12px 16px;border-radius:8px;background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;}
</style>
</head>
<body>
{% include 'Navbar.html' %}

<div class="container">
    <div class="page-header">
        <h1>Our Products</h1>
        <p>Discover fresh groceries and essentials for your home</p>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="Search products..." onkeyup="filterProducts()">
    </div>

    <div class="filters">
        <button class="filter-btn active" onclick="filterByCategory('all', event)">All Products</button>
        {% for category in categories %}
            <button class="filter-btn" onclick="filterByCategory('{{ category }}', event)">{{ category }}</button>
        {% endfor %}
    </div>

    {% if products %}
    <div class="products-grid" id="productsGrid">
        {% for product in products %}
        <div class="product-card" data-category="{{ product.category|default:'' }}" data-name="{{ product.name|lower }}">
            <div class="product-image">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                    <div class="placeholder">ðŸ“¦</div>
                {% endif %}
                {% if product.stock_quantity > 0 %}
                    <div class="product-badge">In Stock</div>
                {% else %}
                    <div class="product-badge" style="background: var(--error);">Out of Stock</div>
                {% endif %}
            </div>
            <div class="product-info">
                {% if product.category %}
                    <p class="product-category">{{ product.category }}</p>
                {% endif %}
                <h3 class="product-name">{{ product.name }}</h3>
                {% if product.description %}
                    <p class="product-description">{{ product.description }}</p>
                {% endif %}
                <p class="product-price">â‚¹{{ product.price|floatformat:2 }}</p>
                <p class="product-stock">
                    {% if product.stock_quantity > 0 %}
                        {{ product.stock_quantity }} in stock
                    {% else %}
                        Out of stock
                    {% endif %}
                </p>
                <div class="product-actions">
                    {% if user.is_authenticated %}
                        {% if product.stock_quantity > 0 %}
                            <button class="btn-add-cart" onclick="addToCart({{ product.id }})" id="addBtn{{ product.id }}">
                                Add to Cart
                            </button>
                        {% else %}
                            <button class="btn-add-cart" disabled>Out of Stock</button>
                        {% endif %}
                    {% else %}
                        <button class="btn-add-cart" onclick="showLoginAlert()">
                            Login to Add
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“¦</div>
        <h2>No Products Available</h2>
        <p>We're working on adding amazing products for you!</p>
    </div>
    {% endif %}
</div>

<script>
function filterByCategory(category, event) {
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const products = document.querySelectorAll('.product-card');
    products.forEach(product => {
        product.style.display = (category === 'all' || product.dataset.category === category) ? 'block' : 'none';
    });
}

function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const products = document.querySelectorAll('.product-card');
    products.forEach(product => {
        const name = product.dataset.name;
        product.style.display = name.includes(searchTerm) ? 'block' : 'none';
    });
}

function addToCart(productId) {
    const button = document.getElementById('addBtn' + productId);
    const originalText = button.textContent;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) { alert('CSRF token missing! Refresh page.'); return; }

    button.textContent = 'Adding...'; button.disabled = true;

    fetch('{% url "add_to_cart" %}', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':csrfToken.value},
        body:`product_id=${productId}&quantity=1`
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){ showMessage('Added to cart!', 'success'); }
        else{ showMessage(data.message || 'Failed to add', 'error'); }
        button.textContent = originalText; button.disabled = false;
    })
    .catch(()=>{ showMessage('Network error', 'error'); button.textContent = originalText; button.disabled=false; });
}

function showLoginAlert(){ showMessage('Please login to add items to cart!', 'error'); }

function showMessage(msg, type) {
    const div = document.createElement('div');
    div.textContent = msg;
    div.style.cssText = `position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;color:white;font-weight:500;z-index:1000;${type==='success'?'background:var(--success)':'background:var(--error)'}`;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),3000);
}
</script>
</body>
</html>
