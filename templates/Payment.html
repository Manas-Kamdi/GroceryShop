<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - GroceryShop</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    {% load static %}
    <script src="{% static 'js/dialog.js' %}"></script>
    <style>
        :root {
            --bg: #f3faf9;
            --text: #0b3f3a;
            --brand: #0f766e;
            --primary: #14b8a6;
            --primary-strong: #0ea5a3;
            --on-primary: #062a27;
            --field: #ffffff;
            --field-border: #c7e7e2;
            --success: #10b981;
            --error: #ef4444;
        }
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
        .container { max-width:1200px; margin:48px auto; padding:0 24px; }
        .payment-header { text-align:center; margin-bottom:32px; }
        .payment-header h1 { font-size:32px; color:var(--brand); margin:0 0 8px 0; }
        .payment-header p { color:#6b7280; font-size:16px; margin:0; }
        .payment-content { display:grid; grid-template-columns:1fr 400px; gap:32px; align-items:start; }
        .payment-form, .order-summary { background:#fff; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.05); padding:32px; }
        .order-summary { position:sticky; top:24px; }
        .form-section { margin-bottom:32px; }
        .form-section h3 { font-size:20px; color:var(--brand); margin:0 0 20px 0; border-bottom:2px solid var(--primary); padding-bottom:8px; }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; font-weight:600; margin-bottom:6px; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:12px 16px; border:1px solid var(--field-border); border-radius:8px; background:var(--field); font-size:16px; outline:none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color:var(--primary); box-shadow:0 0 0 4px rgba(20,184,166,0.15); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
        .order-items { margin-bottom:20px; }
        .order-item { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f3f4f6; }
        .order-item:last-child { border-bottom:none; }
        .item-info { flex:1; }
        .item-name { font-weight:600; margin-bottom:4px; }
        .item-details { color:#6b7280; font-size:14px; }
        .item-price { font-weight:600; color:var(--brand); }
        .summary-row { display:flex; justify-content:space-between; margin-bottom:12px; }
        .summary-row.total { border-top:1px solid #e5e7eb; padding-top:16px; margin-top:16px; font-size:18px; font-weight:600; color:var(--brand); }
        .btn-primary, .btn-secondary { flex:1; padding:16px; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:0.16s ease; text-align:center; text-decoration:none; display:inline-block; }
        .btn-primary { border:none; background:var(--primary); color:var(--on-primary); }
        .btn-primary:hover { background:var(--primary-strong); }
        .btn-primary:disabled { background:#e5e7eb; color:#9ca3af; cursor:not-allowed; }
        .btn-secondary { border:1px solid var(--field-border); background:#fff; color:var(--text); }
        .btn-secondary:hover { background:#f9fafb; }
        .messages { margin-bottom:24px; }
        .messages .success { padding:12px 16px; border-radius:8px; background:#d1fae5; color:#065f46; border:1px solid #a7f3d0; }
        .messages .error { padding:12px 16px; border-radius:8px; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
        .loading { display:none; text-align:center; padding:20px; }
        .loading.show { display:block; }
        .spinner { border:3px solid #f3f3f3; border-top:3px solid var(--primary); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto 10px; }
        @keyframes spin {0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);}}
        @media(max-width:768px) {.payment-content{grid-template-columns:1fr; gap:24px;} .form-row{grid-template-columns:1fr;} .payment-buttons{flex-direction:column;}}
    </style>
</head>
<body>
    {% include 'Navbar.html' %}

    <div class="container">
        <div class="payment-header">
            <h1>Payment & Checkout</h1>
            <p>Complete your order with secure payment</p>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="payment-content">
            <!-- Delivery Form -->
            <div class="payment-form">
                <form id="paymentForm" method="post" action="{% url 'process_payment' %}">
                    {% csrf_token %}
                    <div class="form-section">
                        <h3>Delivery Address</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="delivery_name">Full Name *</label>
                                <input type="text" id="delivery_name" name="delivery_name" value="{{ user.first_name }} {{ user.last_name }}" required>
                            </div>
                            <div class="form-group">
                                <label for="delivery_phone">Phone Number *</label>
                                <input type="tel" id="delivery_phone" name="delivery_phone" value="{{ user.profile.phone|default:'' }}" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="delivery_address">Address *</label>
                            <input type="text" id="delivery_address" name="delivery_address" value="{{ user.profile.address|default:'' }}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="delivery_area">Area *</label>
                                <input type="text" id="delivery_area" name="delivery_area" value="{{ user.profile.area|default:'' }}" required>
                            </div>
                            <div class="form-group">
                                <label for="delivery_pincode">Pincode *</label>
                                <input type="text" id="delivery_pincode" name="delivery_pincode" value="{{ user.profile.pincode|default:'' }}" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="delivery_landmark">Landmark (Optional)</label>
                            <input type="text" id="delivery_landmark" name="delivery_landmark" value="{{ user.profile.landmark|default:'' }}">
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="form-section">
                        <h3>Payment Method</h3>
                        <div class="form-group">
                            <label>Select Payment Method</label>
                            <select id="payment_method" name="payment_method" required>
                                <option value="">Choose payment method</option>
                                <option value="razorpay">Credit/Debit Card (Razorpay)</option>
                                <option value="cod">Cash on Delivery</option>
                            </select>
                        </div>
                    </div>

                    <input type="hidden" id="order_total" name="order_total" value="{{ total_price }}">
                </form>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h3 class="summary-header">Order Summary</h3>
                <div class="order-items">
                    {% for item in cart_items %}
                    <div class="order-item">
                        <div class="item-info">
                            <div class="item-name">{{ item.product.name }}</div>
                            <div class="item-details">Qty: {{ item.quantity }} × ₹{{ item.product.price|floatformat:2 }}</div>
                        </div>
                        <div class="item-price">₹{{ item.total_price|floatformat:2 }}</div>
                    </div>
                    {% endfor %}
                </div>
                <div class="summary-row">
                    <span class="summary-label">Items ({{ total_items }})</span>
                    <span class="summary-value">₹{{ total_price|floatformat:2 }}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Shipping</span>
                    <span class="summary-value">Free</span>
                </div>
                <div class="summary-row total">
                    <span class="summary-label">Total</span>
                    <span class="summary-value">₹{{ total_price|floatformat:2 }}</span>
                </div>

                <div class="payment-buttons">
                    <button type="button" class="btn-primary" onclick="processPayment()">Pay ₹{{ total_price|floatformat:2 }}</button>
                    <a href="{% url 'cart' %}" class="btn-secondary">Back to Cart</a>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processing payment...</p>
                </div>
            </div>
        </div>
    </div>

<script>
const RAZORPAY_KEY_ID = 'YOUR_RAZORPAY_KEY_ID'; // Replace with actual key
const WEBSITE_URL = window.location.protocol + '//' + window.location.host;

function processPayment() {
    const form = document.getElementById('paymentForm');
    const paymentMethod = document.getElementById('payment_method').value;
    const loading = document.getElementById('loading');

    if (!form.checkValidity()) { form.reportValidity(); return; }
    if (!paymentMethod) { alert('Please select a payment method'); return; }

    if (paymentMethod === 'razorpay') { processRazorpayPayment(); }
    else if (paymentMethod === 'cod') { processCODPayment(); }
}

function processRazorpayPayment() {
    const loading = document.getElementById('loading');
    const amount = Math.round(parseFloat(document.getElementById('order_total').value) * 100);
    loading.classList.add('show');

    fetch('{% url "create_razorpay_order" %}', {
        method:'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded', 'X-CSRFToken':document.querySelector('[name=csrfmiddlewaretoken]').value },
        body: `amount=${amount}`
    })
    .then(r => r.json())
    .then(data => {
        loading.classList.remove('show');
        if(data.success){
            const options = {
                key: RAZORPAY_KEY_ID,
                amount: amount,
                currency: 'INR',
                name: 'GroceryShop',
                description: 'Grocery Order Payment',
                order_id: data.order_id,
                handler: function(response){ completePayment(response); },
                prefill: {
                    name: document.getElementById('delivery_name').value,
                    email: '{{ user.email }}',
                    contact: document.getElementById('delivery_phone').value
                },
                theme: { color: '#14b8a6' }
            };
            const rzp = new Razorpay(options); rzp.open();
        } else { alert('Error creating payment order'); }
    })
    .catch(()=>{ loading.classList.remove('show'); alert('Payment processing error'); });
}

function processCODPayment() {
    if(confirm('Confirm Cash on Delivery order?')) {
        const loading = document.getElementById('loading');
        loading.classList.add('show');
        const form = document.getElementById('paymentForm');
        const formData = new FormData(form);
        formData.append('payment_method','cod');

        fetch('{% url "process_payment" %}', { method:'POST', headers:{'X-CSRFToken':document.querySelector('[name=csrfmiddlewaretoken]').value}, body:formData })
        .then(r=>r.json())
        .then(data=>{
            loading.classList.remove('show');
            if(data.success){ alert('Order placed!'); window.location.href='{% url "profile" %}'; }
            else{ alert('Error placing order'); }
        })
        .catch(()=>{ loading.classList.remove('show'); alert('Error placing order'); });
}

function completePayment(response){
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    const form = document.getElementById('paymentForm');
    const formData = new FormData(form);
    formData.append('payment_method','razorpay');
    formData.append('razorpay_payment_id',response.razorpay_payment_id);
    formData.append('razorpay_order_id',response.razorpay_order_id);
    formData.append('razorpay_signature',response.razorpay_signature);

    fetch('{% url "process_payment" %}', { method:'POST', headers:{'X-CSRFToken':document.querySelector('[name=csrfmiddlewaretoken]').value}, body:formData })
    .then(r=>r.json())
    .then(data=>{
        loading.classList.remove('show');
        if(data.success){ alert('Payment successful!'); window.location.href='{% url "profile" %}'; }
        else{ alert('Error processing payment'); }
    })
    .catch(()=>{ loading.classList.remove('show'); alert('Payment error'); });
}

document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('payment_method').value='razor
