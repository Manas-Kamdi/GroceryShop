<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Products - GroceryShop</title>
{% load static %}
<style>
:root {
    --bg:#f3faf9; --text:#0b3f3a; --brand:#0f766e;
    --primary:#14b8a6; --primary-strong:#0ea5a3; --on-primary:#062a27;
    --field:#fff; --field-border:#c7e7e2; --success:#10b981;
    --error:#ef4444; --warning:#f59e0b;
}
body {
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg);
    color:var(--text);
}
.container {max-width:1200px;margin:0 auto;padding:24px;}
.page-header{text-align:center;margin-bottom:48px;}
.page-title{font-size:36px;font-weight:700;color:var(--brand);margin:0 0 16px 0;}
.page-subtitle{font-size:18px;color:#6b7280;margin:0;}
.filters{display:flex;gap:16px;margin-bottom:32px;flex-wrap:wrap;align-items:center;}
.filter-group{display:flex;gap:8px;align-items:center;}
.filter-group label{font-weight:600;font-size:14px;}
.filter-group select,input{
    padding:8px 12px;border:1px solid var(--field-border);
    border-radius:6px;background:var(--field);color:var(--text);
}
.filter-group select:focus,input:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(20,184,166,0.15);
}
.products-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    gap:24px;margin-bottom:48px;
}
.product-card{
    background:var(--field);border-radius:12px;
    box-shadow:0 4px 6px rgba(0,0,0,0.05);
    overflow:hidden;transition:transform 160ms ease,box-shadow 160ms ease;
}
.product-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,0.15);}
.product-image{width:100%;height:200px;object-fit:cover;background:#f8f9fa;}
.product-info{padding:20px;}
.product-name{font-size:18px;font-weight:600;color:var(--brand);margin:0 0 8px 0;}
.product-description{color:#6b7280;font-size:14px;margin:0 0 12px 0;line-height:1.4;}
.product-price{font-size:20px;font-weight:700;color:var(--primary);margin:0 0 16px 0;}
.product-actions{display:flex;gap:8px;}
.btn-add-cart{
    flex:1;padding:10px 16px;background:var(--primary);
    color:var(--on-primary);border:none;border-radius:6px;
    font-weight:600;cursor:pointer;transition:background-color 160ms ease;
}
.btn-add-cart:hover{background:var(--primary-strong);}
.btn-add-cart:disabled{background:#9ca3af;cursor:not-allowed;}
.no-products{text-align:center;padding:48px;color:#6b7280;}
.no-products h3{margin:0 0 16px 0;color:var(--brand);}
.message{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-weight:500;}
.message.success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0;}
.message.error{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;}
.message.warning{background:#fef3c7;color:#92400e;border:1px solid #fde68a;}
@media (max-width:768px){
    .products-grid{grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;}
    .filters{flex-direction:column;align-items:stretch;}
    .filter-group{justify-content:space-between;}
}
</style>
</head>
<body>
{% include 'Navbar.html' %}

<div class="container">
    <div class="page-header">
        <h1 class="page-title">Our Products</h1>
        <p class="page-subtitle">Fresh groceries delivered to your doorstep</p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if products %}
        {% csrf_token %}
        <div class="filters">
            <div class="filter-group">
                <label for="category-filter">Category:</label>
                <select id="category-filter">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="search">Search:</label>
                <input type="text" id="search" placeholder="Search products...">
            </div>
        </div>

        <div class="products-grid" id="products-grid">
            {% for product in products %}
            <div class="product-card" 
                data-category="{{ product.category|default:'' }}" 
                data-name="{{ product.name|lower }}">

                {% if product.image %}
                    <!-- ✅ Media images -->
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                {% else %}
                    <!-- ✅ Fallback static image -->
                    <img src="{% static 'Assets/product-placeholder.png' %}" alt="{{ product.name }}" class="product-image">
                {% endif %}

                <div class="product-info">
                    <h3 class="product-name">{{ product.name }}</h3>
                    {% if product.description %}
                        <p class="product-description">{{ product.description|truncatewords:15 }}</p>
                    {% endif %}
                    <p class="product-price">₹{{ product.price }}</p>

                    <div class="product-actions">
                        {% if user.is_authenticated %}
                            {% if product.stock_quantity > 0 %}
                                <button class="btn-add-cart" onclick="addToCart(event, {{ product.id }})">Add to Cart</button>
                            {% else %}
                                <button class="btn-add-cart" disabled>Out of Stock</button>
                            {% endif %}
                        {% else %}
                            <button class="btn-add-cart" onclick="showLoginAlert()">Add to Cart</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-products">
            <h3>No Products Available</h3>
            <p>We're working on adding amazing products for you. Check back soon!</p>
        </div>
    {% endif %}
</div>

<script>
document.getElementById('category-filter').addEventListener('change', filterProducts);
document.getElementById('search').addEventListener('input', filterProducts);

function filterProducts() {
    const category = document.getElementById('category-filter').value;
    const search = document.getElementById('search').value.toLowerCase();
    const cards = document.querySelectorAll('.product-card');
    cards.forEach(card => {
        const matchCategory = !category || card.dataset.category === category;
        const matchSearch = !search || card.dataset.name.includes(search);
        card.style.display = (matchCategory && matchSearch) ? 'block' : 'none';
    });
}

function addToCart(event, productId) {
    const button = event.currentTarget;
    const originalText = button.textContent;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    button.textContent = 'Adding...';
    button.disabled = true;

    fetch('{% url "add_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `product_id=${productId}&quantity=1`
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) showMessage('Product added to cart!', 'success');
        else showMessage(data.error || 'Failed to add product', 'error');
    })
    .catch(() => showMessage('Network error', 'error'))
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

function showLoginAlert() {
    showMessage('Please log in to add products to cart', 'warning');
    setTimeout(()=>{ window.location.href = '{% url "login" %}'; }, 2000);
}

function showMessage(msg, type='info') {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.textContent = msg;
    div.style.cssText = `position:fixed;top:20px;right:20px;z-index:1000;animation:slideInRight 0.3s ease;`;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),3000);
}

const style = document.createElement('style');
style.textContent = `@keyframes slideInRight{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}`;
document.head.appendChild(style);
</script>
</body>
</html>
